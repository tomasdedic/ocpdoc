<!DOCTYPE html>
<html class="no-js" lang="en-us">
<head><script src="/livereload.js?port=1112&mindelay=10&v=2" data-no-instant defer></script>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>OPENSHIFT AZURE INSTALL and CUSTOMIZE - DIVIDED DOCUMENTATION</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="IPI OPENSHIFT disconnected installation inside Azure datacentre extension ">
	<meta name="generator" content="Hugo 0.75.0-DEV" />
	<meta property="og:title" content="OPENSHIFT AZURE INSTALL and CUSTOMIZE" />
<meta property="og:description" content="IPI OPENSHIFT disconnected installation inside Azure datacentre extension " />
<meta property="og:type" content="article" />
<meta property="og:url" content="//localhost:1112/openshift/install/instalaceazure/" />
<meta property="article:published_time" content="2020-09-30T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-09-30T00:00:00+00:00" />

	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/custom.css">
	<link rel="shortcut icon" href="/favicon.ico">
</head>
<body class="body">
	<div class="container container--outer">
    
		<header class="header">
    
        <script src="https://cdn.jsdelivr.net/npm/lunr@2.3.8/lunr.min.js" defer></script><script src="/js/meme.min.js"></script>

    
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="DIVIDED DOCUMENTATION" rel="home">
				<div class="logo__title">DIVIDED DOCUMENTATION</div>
				<div class="logo__tagline">Tech howto, pancakes and syrup</div> 
			</a>

</form>
		</div>
    <form id="search" class="search" role="search">
    <label for="search-input">
    </label>
    <input type="search" id="search-input" class="search-input">
</form>

<template id="search-result" hidden>
    <article class="content post">
        <h3 class="list__title post__title"><a class="summary-title-link"></a></h2>
        <summary class="summary"></summary>
        <div class="read-more-container">
            <a class="read-more-link"></a>
        </div>
    </article>
</template>

		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
  <ul class="menu__list">
    <li class="menu__item">
      <a class="menu__link" href="/categories/azure/" title="Azure">Azure</a>
    <li class="menu__item">
      <a class="menu__link" href="/categories/logging/" title="Logging">Logging</a>
    <li class="menu__item">
      <a class="menu__link" href="/categories/openshift/" title="Openshift">Openshift</a>
    </li>
  </ul>
</nav>

	</div>
</header>

    
		<div class="wrapper flex">
			<div class="primary">
			
 

<main class="main" role="main">
	<article class="post" autonumbering>
		<header class="post__header">
			<h1 class="post__title">OPENSHIFT AZURE INSTALL and CUSTOMIZE</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg>
	<time class="meta__text" datetime="2020-09-30T00:00:00">2020-09-30</time>
</div>

<div class="meta__item-categories meta__item">
	<svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
	<span class="meta__text"><a class="meta__link" href="/categories/openshift/" rel="category">OPENSHIFT</a></span>
</div>

<div class="meta__item-categories meta__item">
	<svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<span class="meta__text"><a class="meta__link" href="/tags/install/" rel="category">INSTALL</a></span>
</div>
</div>
		</header>
		
    
		<div class="content post__content clearfix">
        <div class="post__toc toc">
	      <div class="toc__title">Content</div>
	      <div class="toc__menu">
          
          <nav id="TableOfContents">
  <ul>
    <li><a href="#přípravné-kroky">Přípravné kroky</a>
      <ul>
        <li><a href="#private-dns-zone">Private DNS zone</a></li>
        <li><a href="#příprava-azure-účtu-a-service-principals">Příprava Azure účtu a service principals</a></li>
        <li><a href="#redhat-pull-secret">Redhat pull secret</a></li>
        <li><a href="#konfigurační-soubory-azure">Konfigurační soubory Azure</a></li>
        <li><a href="#ssh-klíče">SSH klíče</a></li>
        <li><a href="#create-azure-vnet-and-install-with-existing-vnet">Create Azure Vnet and Install with existing VNET</a></li>
      </ul>
    </li>
    <li><a href="#síťové-prostupy">Síťové prostupy</a></li>
    <li><a href="#konfigurace-cluster-wide-proxy">Konfigurace cluster-wide proxy</a></li>
    <li><a href="#instalace-typu-internal-do-private-zóny">Instalace typu &ldquo;INTERNAL&rdquo; do private zóny</a>
      <ul>
        <li><a href="#instalační-balíčky">Instalační balíčky</a></li>
        <li><a href="#použití-artifactory-jako-container-registry">Použití Artifactory jako container registry</a></li>
        <li><a href="#instalační-soubor-install-configyaml">Instalační soubor INSTALL-CONFIG.YAML</a></li>
        <li><a href="#spuštění-instalace-a-případný-debug">Spuštění instalace a případný debug</a></li>
        <li><a href="#uninstall-proces">Uninstall proces</a></li>
      </ul>
    </li>
  </ul>
</nav>
	      </div>
        </div>
      
      <div class="post__item">
        
        *file: instalace_popis.md *
      </div><h1 id="popis-instalace-openshift-4x-stable-build-v-prostředí-azure">POPIS INSTALACE OPENSHIFT 4.x stable build v prostředí Azure</h1>
<p>Popis instalace OpenShift ve verzi 4.x jako publish Internal tedy s definicí endpointů do private zóny.</p>
<h2 id="přípravné-kroky">Přípravné kroky</h2>
<h3 id="private-dns-zone">Private DNS zone</h3>
<p>Při instalaci je potřeba nakonfigurovat automaticky vytvořenou <strong>private DNS zone</strong> tak že k ní budou přilinkovány Azure Vnet.<br>
Privatni DNS zona se nechova jako klasicky DNS server, nemá IP adresy na které by se dala
forwardnout z jinych DNS serveru.
Zaznamy z ní muzou resolvnout pouze VM umisteny v Azure Vnet, která je přilinkovaná k
private DNS zóně a to pouze za předpokladu že pro resolvování záznamu v těchto zónách
používají Azure DNS server (168.63.129.16)</p>
<p>V Azure je pro přilinkování vytvořena policy která by měla během cca 10 minut provést přilinkování potřebných vnet k vytvořené private DNS zóně.<br>
Konfigurace by pak měla vypadat následovně:
<figure>
    <img src="img/virtual_network_link-proprivateDNS.png"
         alt="privateDNS virtual-network-links"/> <figcaption>
            <p>privateDNS virtual-network-links</p>
        </figcaption>
</figure>
</p>
<h3 id="příprava-azure-účtu-a-service-principals">Příprava Azure účtu a service principals</h3>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">az login
az account show
 <span style="color:#080;font-style:italic">#define service principals</span>
az ad sp create-for-rbac --name service_principal_name
 <span style="color:#080;font-style:italic">#add roles</span>
az role assignment create --assignee <span style="color:#b44">&#34;app id of service principal&#34;</span> --role Contributor --output none
az role assignment create --assignee <span style="color:#b44">&#34;app id of service principal&#34;</span> --role <span style="color:#b44">&#34;User Access Administrator&#34;</span> --output none
 <span style="color:#080;font-style:italic"># service principal needs read write owned by app permisions azure AD graph</span>
az ad app permission add --id <span style="color:#b44">&#34;app id of service principal&#34;</span> <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>-- api 00000002-0000-0000-c000-000000000000 <span style="color:#b62;font-weight:bold">\
</span><span style="color:#b62;font-weight:bold"></span>-- api-permissions 824c81eb0e3f8-4ee6-8f6d-de7f50d565b7-Role
 <span style="color:#080;font-style:italic">#subscription id</span>
az account list --output table
 <span style="color:#080;font-style:italic">#tenant id --&gt; when create service principals</span>
 <span style="color:#080;font-style:italic">#service principal client id --&gt;app id when created service principal</span>
 <span style="color:#080;font-style:italic"># service principal client secret --&gt;output of service principal</span>
</code></pre></div><h3 id="redhat-pull-secret">Redhat pull secret</h3>
<p>Redhat pull secret získáme z <a href="https://cloud.redhat.com/openshift/install/azure/installer-provisioned">(redhat-pull-secret)</a></p>
<h3 id="konfigurační-soubory-azure">Konfigurační soubory Azure</h3>
<p>Pro service principals vytvoříme soubor <em>~/.azure/osServicePrincipal.json</em> s obsahem dle vytvořeného service principal s následující strukturou:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">touch ~/.azure/osServicePrincipal.json
<span style="color:#666">{</span><span style="color:#b44">&#34;subscriptionId&#34;</span>:<span style="color:#b44">&#34;7504de90-f639-4328-a5b6-fde85e0a7fd9&#34;</span>,<span style="color:#b44">&#34;clientId&#34;</span>:<span style="color:#b44">&#34;126501b0-ae03-4aad-aff2-19ced106b169&#34;</span>,<span style="color:#b44">&#34;clientSecret&#34;</span>:<span style="color:#b44">&#34;********&#34;</span>,<span style="color:#b44">&#34;tenantId&#34;</span>:<span style="color:#b44">&#34;d2480fab-7029-4378-9e54-3b7a474eb327&#34;</span><span style="color:#666">}</span>
</code></pre></div><p>Pro různé instalace do stejné subskripce můžeme využít stejné service principals.</p>
<p>Adresář <em>~/.azure</em> pak bude vypadat následovně:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">.azure/
├── accessTokens.json
├── azureProfile.json
└── osServicePrincipal.json
</code></pre></div><h3 id="ssh-klíče">SSH klíče</h3>
<p>Vytvoříme ssh klíče pro přístup na jednotlivé nody OCP.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">ssh-keygen -f <span style="color:#b8860b">$HOME</span>/.ssh/id_dsa -t dsa -b <span style="color:#666">1024</span>
chmod <span style="color:#666">700</span> ~/.ssh
</code></pre></div><h3 id="create-azure-vnet-and-install-with-existing-vnet">Create Azure Vnet and Install with existing VNET</h3>
<blockquote>
<p>předpokládáme instalaci do existujících VNET je tedy potřeba pouze zkontrolovat nastavení NSG</p>
</blockquote>
<p>Vytvořit Azure Vnet s dvěmi <strong>subnety</strong> (jednu pro master nody a jednu pro worker nody).
<figure>
    <img src="img/vnet-definition.png"
         alt="vnet definition"/> <figcaption>
            <p>vnet definition</p>
        </figcaption>
</figure>
</p>
<p>Pro každou subnet vytvořit NSG(network security group) a přiřadit příslušným subnet. Hlavní důvod je ssh přístup na bootstrap VM, z kterého instalátor pracuje.<br>
<em>Pozn: Při instalaci se NSG vytvoří automaticky v resource_group OCP objektů jen se nepřiřadí Subnetu, lze tedy použít i tu. Pokud se tak rozhodnete je potřeba to provést v průběhu instalace (provisioning objektů v Azure se dělá jako první).</em></p>
<p><figure>
    <img src="img/masterNSG.png"
         alt="NSG pro master nodes"/> <figcaption>
            <p>NSG pro master nodes</p>
        </figcaption>
</figure>

<figure>
    <img src="img/workerNSG.png"
         alt="NSG pro worker nodes"/> <figcaption>
            <p>NSG pro worker nodes</p>
        </figcaption>
</figure>
</p>
<p>yaml defince vnet(v samostatné RG)resouce_group:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#080;font-style:italic"># install-config.yaml snippet</span><span style="color:#bbb">
</span><span style="color:#bbb">	</span>poshi_vnet_rg<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">vnet</span>:<span style="color:#bbb">
</span><span style="color:#bbb">	</span>poshi_vnet 10.2.0.0/16<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">subnet</span>:<span style="color:#bbb">
</span><span style="color:#bbb">	</span>poshi-worker-subnet 10.2.32.0/19<span style="color:#bbb">
</span><span style="color:#bbb">	</span>poshi-master-subnet 10.2.0.0/19<span style="color:#bbb">
</span></code></pre></div><h2 id="síťové-prostupy">Síťové prostupy</h2>
<p>Instalace se provádí v topologii HUB_and_SPOKE se předkonfigurovaným routingem(route table ve VNET) , z pohledu Openshiftu UserDefinedRouting.<br>
Pro instalaci v privátní zóně by měla být veškerá komunikace mimo privátní rozsah směrována přez proxy. Ne všechny kontejnery však přejímají nastavení CRD proxy.config jako ENV variable a je potřeba povolit komunikaci na VSEC GW.</p>
<table>
<thead>
<tr>
<th>domény povolené na VSEC GW</th>
</tr>
</thead>
<tbody>
<tr>
<td>.blob.core.windows.net</td>
</tr>
<tr>
<td>login.microsoftonline.com</td>
</tr>
<tr>
<td>management.azure.com</td>
</tr>
</tbody>
</table>
<h2 id="konfigurace-cluster-wide-proxy">Konfigurace cluster-wide proxy</h2>
<p><a href="/openshift/install/nastaveni_proxy/">link: KONFIGURACE PROXY</a><br>
Jako proxy bude použita:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">httpProxy: http://ngproxy-test.csint.cz:8080
httpsProxy: http://ngproxy-test.csint.cz:8080
</code></pre></div><h2 id="instalace-typu-internal-do-private-zóny">Instalace typu &ldquo;INTERNAL&rdquo; do private zóny</h2>
<p>Rozdíl mezi intalací typu Internal a External je pouze v publikaci endpointů.</p>
<h3 id="instalační-balíčky">Instalační balíčky</h3>
<p>Stáhneme a rozbalíme balíky <em>openshift-client, openshift-install</em>.</p>
<ul>
<li><a href="https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/">(stable installer)</a></li>
<li><a href="https://mirror.openshift.com/pub/openshift-v4/clients/ocp-dev-preview/">(dev preview installer)</a><br>
Při instalaci dev preview nebudou fungovat upgrady na vyšší verze.</li>
</ul>
<p><a href="https://github.com/openshift/installer/blob/master/docs/user/customization.md#platform-customization">link na custom properties</a><br>
<a href="https://github.com/openshift/installer/blob/master/docs/user/azure/customization.md">link na azure platform properties</a></p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#080;font-style:italic"># jednotlivé elementy použitelné pro install-config.yaml lze vypsat </span>
openshift-install explain installconfig
</code></pre></div><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#080;font-style:italic"># necháme si vygenerovat konfigurační soubor který budeme dál upravovat</span>
openshift-install create install-config --dir ./install_dir --log-level debug
</code></pre></div><h3 id="použití-artifactory-jako-container-registry">Použití Artifactory jako container registry</h3>
<p>Pro instalaci a používání OCP v privátní síti bude jako zdroj všech kontejnerů využita Artifactory. Všechny remote repository (vnější) budou whitelistovány přez ní a bude pro ně vytvořena konfigurace.<br>
<a href="/openshift/artifactory_as_proxy_for_containerregistries/">link: ARTIFACTORY_AS_PROXY_FOR_CONTAINERREGISTRIES obecně</a><br>
<a href="/openshift/artifactory_as_proxy_for_containerregistries/#pou%C5%BEit%C3%AD-remote-repository-p%C5%99i-instalaci-ocp-quayio-repository">link: ARTIFACTORY_AS_PROXY_FOR_CONTAINERREGISTRIES uprava install-config.yaml</a></p>
<h3 id="instalační-soubor-install-configyaml">Instalační soubor INSTALL-CONFIG.YAML</h3>
<p>následně upravíme vygenerovaný ~/install_dir/install-config.yaml, důležité části jsou s komentáři





  <br>
  <em>[ src/install-config.yaml ]</em>
  
  
  <div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#008000;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">baseDomain</span>:<span style="color:#bbb"> </span>azure.csint.cz<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">additionalTrustBundle</span>:<span style="color:#bbb"> </span><span style="color:#b44;font-style:italic">|
</span><span style="color:#b44;font-style:italic">  # CSAS CA
</span><span style="color:#b44;font-style:italic">  -----BEGIN CERTIFICATE-----
</span><span style="color:#b44;font-style:italic">  # pem
</span><span style="color:#b44;font-style:italic">  -----END CERTIFICATE-----</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">compute</span>:<span style="color:#bbb">
</span><span style="color:#bbb"></span>- <span style="color:#008000;font-weight:bold">architecture</span>:<span style="color:#bbb"> </span>amd64<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">hyperthreading</span>:<span style="color:#bbb"> </span>Enabled<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>worker<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">platform</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">azure</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>Standard_D4s_v3<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">osDisk</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># upravena velikost OS disku</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">diskSizeGB</span>:<span style="color:#bbb"> </span><span style="color:#666">256</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">3</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">controlPlane</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">architecture</span>:<span style="color:#bbb"> </span>amd64<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">hyperthreading</span>:<span style="color:#bbb"> </span>Enabled<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>master<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">platform</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">azure</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">type</span>:<span style="color:#bbb"> </span>Standard_D4s_v3<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#008000;font-weight:bold">osDisk</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#080;font-style:italic"># upravena velikost OS disku</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#008000;font-weight:bold">diskSizeGB</span>:<span style="color:#bbb"> </span><span style="color:#666">256</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">replicas</span>:<span style="color:#bbb"> </span><span style="color:#666">3</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">creationTimestamp</span>:<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">null</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">name</span>:<span style="color:#bbb"> </span>oaz-dev<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">proxy</span>:<span style="color:#bbb">
</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">proxy</span>:<span style="color:#bbb">
</span><span style="color:#bbb">   </span><span style="color:#008000;font-weight:bold">httpProxy</span>:<span style="color:#bbb"> </span>http://ngproxy-test.csint.cz:8080<span style="color:#bbb">
</span><span style="color:#bbb">   </span><span style="color:#008000;font-weight:bold">httpsProxy</span>:<span style="color:#bbb"> </span>http://ngproxy-test.csint.cz:8080<span style="color:#bbb">
</span><span style="color:#bbb">   </span><span style="color:#008000;font-weight:bold">noProxy</span>:<span style="color:#bbb"> </span>login.microsoftonline.com,management.azure.com,.blob.core.windows.net,.csint.cz<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">networking</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">clusterNetwork</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#008000;font-weight:bold">cidr</span>:<span style="color:#bbb"> </span><span style="color:#666">10.128.0.0</span>/14<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">hostPrefix</span>:<span style="color:#bbb"> </span><span style="color:#666">23</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">machineNetwork</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># rozsah pridelene VNETY</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#008000;font-weight:bold">cidr</span>:<span style="color:#bbb"> </span><span style="color:#666">10.88.232.0</span>/23<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">networkType</span>:<span style="color:#bbb"> </span>OpenShiftSDN<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">serviceNetwork</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#666">172.30.0.0</span>/16<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">platform</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">azure</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">region</span>:<span style="color:#bbb"> </span>westeurope<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">networkResourceGroupName</span>:<span style="color:#bbb"> </span>oaz-test-net-rg<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">virtualNetwork</span>:<span style="color:#bbb"> </span>oaz-test-vnet<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">controlPlaneSubnet</span>:<span style="color:#bbb"> </span>Master2<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">computeSubnet</span>:<span style="color:#bbb"> </span>App2 <span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#080;font-style:italic"># pouziti azure route table</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">outboundType</span>:<span style="color:#bbb"> </span>UserDefinedRouting<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">baseDomainResourceGroupName</span>:<span style="color:#bbb"> </span>openshift_az-dev-shared-rg<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#080;font-style:italic"># typ publikace external vs internal </span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">publish</span>:<span style="color:#bbb"> </span>Internal<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">pullSecret</span>:<span style="color:#bbb"> </span><span style="color:#b44">&#39;{&#34;auths&#34;:{&#34;artifactory.csin.cz&#34;:{&#34;auth&#34;:&#34;b2NwOlRyZTVaaXpxbEdKT1NZdzhCUVZ5ZGFXbjk0eVZNZg==&#34;,&#34;email&#34;:&#34;myemail&#34;}}}&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">sshKey</span>:<span style="color:#bbb"> </span><span style="color:#b44;font-style:italic">|
</span><span style="color:#b44;font-style:italic">  # ssh klic pro pristup na uzivatele core jednotlivych nodu
</span><span style="color:#b44;font-style:italic">  ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCt7DDUmaM1mMn9nW8L8iT6Ivh59k9Hq/QsljQV5iuKT9emRHCgbwoTBAlZUqq+ymyqlGut1ZWhH7hVZlCx0Aq5q232pspwJ5+pZ8HkfgU9RNSgvUrh0/jsZBZqpBIQ+gQKAWABVSbB0oMSUz+9bkiiFF/AyEWpmiY34U3BFNalckH1pEmA7xD0uzB+LO0J6jwsIYaBWgHZmrDhQKa/4wrt6Dy06ZQm2QfIKmTT7CV1g8v5Ftf+yG7hgHS7zm+Citlq/Pnzd5gggs42DnKCJICV/viGkRjJkX8XsFLCHsfAOBqw8hTRXMtBVBA2jMUT+q6wAbV5BiQWZdbk4/MZJqAVlQXYcczz9u4TBXP1bHlkj/r4gqwzakLIVZE4eEnb0kX0DuNnKy7wN5U2iyHkox0M6021vuDq9ARmbYqty/5VwgvFCt9YHNvxr0bP8Zz3bpEf8JrAnOGHjbPhnVh0ZGFO1EWMbgTT9DpbnHJfcK3AJaFBhyD8jtbJgsKOjcVqmYrJhhAKwW7vqu54zCit510svOu7rBUegRr4z+MgbTuXXspUcqWXSBjBiAmKptOpbWt0x15oj6M/wapc2EnjvCkSvo42iImX7rPD3F62AK8ByDsbBxU8yLTsjiv8TTJAGGE77ir22JG1Qg2gElg7c4lWkjJ4Srsh8Dl+Pjq5znoAWQ== bastion-oaz-dev</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">imageContentSources</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#080;font-style:italic"># odkaz na artifactory remote repo</span><span style="color:#bbb">
</span><span style="color:#bbb"></span>- <span style="color:#008000;font-weight:bold">mirrors</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- artifactory.csin.cz/docker-quay/openshift-release-dev/ocp-release<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">source</span>:<span style="color:#bbb"> </span>quay.io/openshift-release-dev/ocp-release<span style="color:#bbb">
</span><span style="color:#bbb"></span>- <span style="color:#008000;font-weight:bold">mirrors</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- artifactory.csin.cz/docker-quay/openshift-release-dev/ocp-v4.0-art-dev<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#008000;font-weight:bold">source</span>:<span style="color:#bbb"> </span>quay.io/openshift-release-dev/ocp-v4.0-art-dev<span style="color:#bbb">
</span><span style="color:#bbb">
</span></code></pre></div>


</p>
<h3 id="spuštění-instalace-a-případný-debug">Spuštění instalace a případný debug</h3>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"> <span style="color:#080;font-style:italic"># install </span>
openshift-install create cluster --dir ./install_dir --log-level debug
 <span style="color:#080;font-style:italic"># openshift vytvoří svojí resource group v subskripci</span>
  INFO Waiting up to 30m0s <span style="color:#a2f;font-weight:bold">for</span> the cluster at https://api.DNS:6443 to initialize...
  INFO Waiting up to 10m0s <span style="color:#a2f;font-weight:bold">for</span> the openshift-console route to be created...
  INFO Install complete!
</code></pre></div><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#080;font-style:italic"># test</span>
<span style="color:#a2f">export</span> <span style="color:#b8860b">KUBECONFIG</span><span style="color:#666">=</span><span style="color:#a2f;font-weight:bold">$(</span><span style="color:#a2f">pwd</span><span style="color:#a2f;font-weight:bold">)</span>/install_dir/auth/kubeconfig
oc login --username<span style="color:#666">=</span>kubeadmin --password<span style="color:#666">=</span><span style="color:#b44">&#39;password&#39;</span>
oc get clusterversion
oc get nodes
oc get clusteroperators
 <span style="color:#080;font-style:italic"># konfigurace a její uložení na FS, tento krok není nutný</span>
oc adm must-gather
</code></pre></div><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#080;font-style:italic"># bootstrap server debug</span>
openshift-install gather bootstrap --bootstrap 51.124.79.94 --master 51.124.94.42
openshift-install gather bootstrap
</code></pre></div><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#080;font-style:italic"># bootstrap journal logs</span>
journalctl -b  -u release-image.service -u bootkube.service|grep -E <span style="color:#b44">&#34;E[[:digit:]]{4}&#34;</span>
journalctl -b -f -u release-image.service -u bootkube.service
 <span style="color:#080;font-style:italic"># grep all https://</span>
<span style="color:#a2f;font-weight:bold">for</span> i in <span style="color:#a2f;font-weight:bold">$(</span>find . -name <span style="color:#b62;font-weight:bold">\*</span>.log<span style="color:#a2f;font-weight:bold">)</span>; <span style="color:#a2f;font-weight:bold">do</span> cat <span style="color:#b8860b">$i</span>|grep http; <span style="color:#a2f;font-weight:bold">done</span>|grep -Eo <span style="color:#b44">&#34;https:\/\/[[:graph:]]*&#34;</span>
</code></pre></div><h3 id="uninstall-proces">Uninstall proces</h3>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">openshift-install destroy cluster --dir ./install_dir --log-level debug
</code></pre></div><p>Provision části které vytvořil OCP při instalaci budou smazány (týká se to jeho vlastní RG v Azure)</p>
</div>
		
<div class="post__tags tags clearfix">
	<svg class="icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link btn" href="/tags/install/" rel="tag">Install</a></li>
	</ul>
</div>

	</article>
  
  
</main>































































<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Tomáš Dědič avatar" src="/img/avatar.png" class="avatar" height="30" width="30">
	</figure>
	<div class="authorbox__header">
		
		<span class="authorbox__name">Tomáš Dědič</span>
	</div>
	
	
	
	
	
</div>


<nav class="post-nav flex">
	<div class="post-nav__item post-nav__item--prev">
		<a class="post-nav__link" href="/openshift/artifactory_as_proxy_for_containerregistries/" rel="prev"><span class="post-nav__caption">«&thinsp;Previous</span><p class="post-nav__post-title">Konfigurace OCP pro použití Artifactory remote repository</p></a>
	</div>
	<div class="post-nav__item post-nav__item--next">
		<a class="post-nav__link" href="/openshift/install/nastaveni_proxy/" rel="next"><span class="post-nav__caption">Next&thinsp;»</span><p class="post-nav__post-title">OCP Konfigurace proxy</p></a>
	</div>
</nav>

			</div>
			

		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2020 DIVIDED DOCUMENTATION.
			
		</div>
	</div>
</footer>

	</div>
<script async defer src="/js/menu.js"></script></body>
</html>
