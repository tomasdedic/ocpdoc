<!DOCTYPE html>
<html class="no-js" lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>GKE custom load and scalling - MADDIV</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="GKE testy, NFS persistence, generování loadu ">
	<meta name="generator" content="Hugo 0.53-DEV" />
	<meta property="og:title" content="GKE custom load and scalling" />
<meta property="og:description" content="GKE testy, NFS persistence, generování loadu " />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/gke-customload-zacatky/" /><meta property="article:published_time" content="2019-03-01T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2019-03-01T00:00:00&#43;00:00"/>

	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/custom.css">
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="MADDIV" rel="home">
				<div class="logo__title">MADDIV</div>
				<div class="logo__tagline">Tech howto and my progress</div>
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item menu__item--active">
			<a class="menu__link" href="/post/gke-customload-zacatky/">GKE custom load and scalling</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/post/biometry/">deploy BIOMETRY on GKE</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">GKE custom load and scalling</h1>
			<p class="post__lead">Začátky práce s GKE, vytvoření a test škálování</p>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg>
	<time class="meta__text" datetime="2019-03-01T00:00:00">March 01, 2019</time>
</div>

<div class="meta__item-categories meta__item">
	<svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
	<span class="meta__text"><a class="meta__link" href="/categories/google-cloud-engine" rel="category">Google Cloud Engine</a></span>
</div>
</div>
		</header><div class="content post__content clearfix">
			

<h3 id="kubernetes-gce-autoscaler">Kubernetes GCE autoscaler</h3>

<p>pouzijeme autoscale funkcionalitu clusteru a uvidime jak se to vlastne chova
!!!!zatim vynecham a vrhnema se na deployment a replicas</p>

<pre><code class="language-bash">gcloud container clusters create autoscale-cluster \
--zone europe-west1-c \
--machine-type &quot;g1-small&quot; \
--disk-type &quot;pd-standard&quot; \
--disk-size &quot;10&quot; \
--node-locations &quot;europe-west1-c&quot; \
--num-nodes 2 --enable-autoscaling --min-nodes 1 --max-nodes 4 --enable-cloud-monitoring --addons HorizontalPodAutoscaling,HttpLoadBalancing
</code></pre>

<p>Trochu nechapu to ze autoscale se pouziva na nody ale ja bych ho spise potreboval na pody. Otestuju.
Puvodni myslenka ze prez netcat vyspavnim md5sum /dev/zero a budu tim zatezovat CPU uplne nevychazi jelikoz se mi nedari disownout proces ktery pousti netcat. Netcat tim ceka nez proces dobehne a muzu tak pustit max 1.
Skusim pouzit <strong>at command</strong> pro nashedulovani jobu prez netcat.</p>

<pre><code class="language-bash">at now + 1 minute -f script.sh
</code></pre>

<h3 id="deployments">Deployments</h3>

<p>A Deployment controller provides declarative updates for Pods and ReplicaSets.
vytvorime yaml:</p>

<p><a href="~/git_repositories/work/gce-kubernetes/kubeloaddeployment.yaml">kubeloaddeployment.yaml</a>
<a href="~/git_repositories/work/gce-kubernetes/kubeload-service.yaml">kubeload-service.yaml</a></p>

<pre><code class="language-yaml">--- deployment spec kubeloaddeployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kubeload-deployment
  labels:
    app: load
spec:
  replicas: 3
  selector:
    matchLabels:
      app: load
  template:
    metadata:
      labels:
        app: load
    spec:
      containers:
        - name: kubeload
          image: veryraven/cmindeb:v2
          ports:
            - containerPort: 1500
</code></pre>

<pre><code class="language-bash">kubectl create -f kubeloaddeployment.yaml
#prepiseme ho jako 
kubectl apply -f novydeploy.yaml
kubectl get pods --show-labels
kubectl get deployments
kubectl rollout status deployment.v1.apps/kubeload-deployment
#image update tady uplne nevim 
kubectl --record deployment.apps/kubeload-deployment set image deployment.v1.apps/kubeload-deployment kubeload=veryraven/cmindeb:v3
kubectl set image deployment.v1.apps/kubeload-deployment kubeload=veryraven/cmindeb:v3 --record=true
kubectl describe deployments
kubectl get deployment kubeload-deployment -o yaml

#kdyz udelam chybu pri zmene tak rollback 
kubectl rollout history deployment.v1.apps/kubeload-deployment
kubectl rollout history deployment.v1.apps/kubeload-deployment --revision=2
kubectl rollout undo deployment.v1.apps/kubeload-deployment
#Alternatively, you can rollback to a specific revision by specify that in --to-revision

#scaling
kubectl scale deployment.v1.apps/kubeload-deployment --replicas=10
#Assuming horizontal pod autoscaling is enabled in your cluster, you can setup an autoscaler for your Deployment and choose the minimum and maximum number of Pods you want to run based on the CPU utilization of your existing Pods.
# average utilization 80%CPU 
kubectl autoscale deployment.v1.apps/kubeload-deployment --min=10 --max=15 --cpu-percent=80
kubectl get hpa #HorizontalPodAutoscaling settings
</code></pre>

<h3 id="generovani-loadu-a-test-autoscaling">generovani loadu a test autoscaling</h3>

<ul>
<li>muzeme pouzit autoscale horizontal nodes, autoscale horizontal pods, autoscale vertical pods</li>
<li>pouzijeme slabsi stroje pro cluster</li>
</ul>

<pre><code class="language-bash">  gcloud compute machine-types list
  gcloud container clusters create autoscale-cluster \
  --zone europe-west1-c \
  --machine-type &quot;g1-small&quot; \
  --disk-type &quot;pd-standard&quot; \
  --disk-size &quot;10&quot; \
  --node-locations &quot;europe-west1-c&quot; \
  --num-nodes 1 --enable-autoscaling --min-nodes 1 --max-nodes 4 --enable-cloud-monitoring --addons HorizontalPodAutoscaling,HttpLoadBalancing

kubectl create -f kubeloaddeployment.yaml
kubectl create -f kubeload-service.yaml
kubectl autoscale deployment.v1.apps/kubeload-deployment --min=1 --max=15 --cpu-percent=20
kubectl get services #najdeme public endpoint
telnet ENDPOINT 1500
kubectl get hpa # vidime jak se rozjizdi load
</code></pre>

<h3 id="autoscaling-on-multiple-metrics">AUTOSCALING on multiple metrics</h3>

<pre><code class="language-bash">kubectl top pods
kubectl top nodes
</code></pre>

<p><strong>tady je zajimave ruzne API pro volani, zcela nerozumim rozdilu mezi jednotlivymi API verzemi</strong></p>

<pre><code class="language-bash">--nefunguje:
kubectl get deployment.v2beta1.apps -o yaml

--ale funguje
kubectl get hpa.v2beta1.autoscaling -o yaml
--zaroven funguje
kubectl get hpa.v1.autoscaling -o yaml
</code></pre>

<p>&mdash;&gt; custom metriky jsou dost slozite a asi to bude chtit prozkoumat API server co umoznuje, idealne konečně pochopit SWAGGER abych si vyjel vše co umožňuje API</p>

<h3 id="persistent-disk-between-kubernetes-pods">PERSISTENT DISK between kubernetes pods</h3>

<hr />

<p>Myšlenka je taková mít jeden disk pro logování který se automaticky připojí k novému <strong>podu</strong> po jeho zařazení.</p>

<p><em>Kubernetes has volumes. Volumes let your pod write to a filesystem that exists as long as the pod exists.</em></p>

<p>Type of storage         How long does it last?<br />
Container filesystem    Container lifetime<br />
Volume                  Pod lifetime<br />
Persistent volume       Cluster lifetime</p>

<p>Postavíme samostatný NFS server který bude prezentovat data.</p>

<pre><code class="language-bash">gcloud compute disks create --size=1GB --zone=&quot;europe-west1-c&quot; kp-nfs-disk
</code></pre>

<p>Vytvoříme NFS server
<a href="~/git_repositories/work/gce-kubernetes/nfs-server.yaml">nfs-server.yaml</a>
Vytvoříme příslušné service
<a href="~/git_repositories/work/gce-kubernetes/nfs-service.yaml">nfs-service.yaml</a>
Create Persistent Volume and Persistent Volume Claims
<a href="~/git_repositories/work/gce-kubernetes/persistent-volume-claim.yaml">persistent-volume-claim.yaml</a>
Použije se pak pro pody aby věděli co claimovat
Jediný trik je v adresaci nfs server mělo by to být něco jako <strong>service-name.namespace.svc.cluster.local</strong> v našem případě nfs-service.default.svc.cluster.local a nebo IP adresa</p>

<pre><code class="language-yaml">  nfs:
    server: 10.19.249.83
    path: &quot;/&quot;
</code></pre>

<p>Poslední krok je upravit POD aby reflektovat a automountoval
<a href="~/git_repositories/work/gce-kubernetes/kubeload-deployment-nfs.yaml">kubeload-deployment-nfs.yaml</a></p>

		</div>
		
<div class="post__tags tags clearfix">
	<svg class="icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link btn" href="/tags/gke/" rel="tag">GKE</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/docker/" rel="tag">docker</a></li>
	</ul>
</div>
	</article>
</main>


<nav class="post-nav flex">
	<div class="post-nav__item post-nav__item--next">
		<a class="post-nav__link" href="/post/docker-custom/" rel="next"><span class="post-nav__caption">Next&thinsp;»</span><p class="post-nav__post-title">Docker custom image</p></a>
	</div>
</nav>


			</div>
			<aside class="sidebar">
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/post/kubernetes-scaling-create-load/">Kubernetes LOAD service on Docker container</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/kubernetes-api-curl/">Kubernetes API CURL</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/biometry/">deploy BIOMETRY on GKE</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/docker-custom/">Docker custom image</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/gke-customload-zacatky/">GKE custom load and scalling</a></li>
		</ul>
	</div>
</div>
<div class="widget-categories widget">
	<h4 class="widget__title">Categories</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/categories/docker">Docker</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/google-cloud-engine">Google cloud engine</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/kubernetes">Kubernetes</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/prometheus">Prometheus</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/scaling">Scaling</a></li>
		</ul>
	</div>
</div>
<div class="widget-taglist widget">
	<h4 class="widget__title">Tags</h4>
	<div class="widget__content">
		<a class="widget-taglist__link widget__link btn" href="/tags/api" title="Api">Api</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/docker" title="Docker">Docker</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/gce" title="Gce">Gce</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/gke" title="Gke">Gke</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/kubernetes" title="Kubernetes">Kubernetes</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/prometheus" title="Prometheus">Prometheus</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/scaling" title="Scaling">Scaling</a>
	</div>
</div>
</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2019 MADDIV.
			
		</div>
	</div>
</footer>

	</div>
<script async defer src="/js/menu.js"></script></body>
</html>